<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa interactivo de problemas</title>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Leaflet.Draw (para pol√≠gonos / √°reas) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- Geocoder (buscar lugares) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    :root{
      --bg:#0b132b; --panel:#1c2541; --muted:#3a506b; --accent:#5bc0be; --accent2:#ffd166; --text:#eaf2f8; --ok:#4caf50; --warn:#ff9800; --bad:#ef5350;
      --radius:18px;
    }
    /* Tema claro */
    body[data-theme="light"]{
      --bg:#ffffff; --panel:#f4f6fb; --muted:#cbd5e1; --accent:#2563eb; --accent2:#f59e0b; --text:#1f2937; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text);}
    .app{display:grid; grid-template-columns:380px 1fr; min-height:100vh}

    /* Sidebar */
    aside{
      background:linear-gradient(180deg, var(--panel), #121a35);
      padding:16px 16px 24px; border-right:1px solid #243057; position:relative;
    }
    h1{font-size:20px; margin:0 0 10px; letter-spacing:.2px}
    .subtitle{opacity:.8; font-size:12px; margin-bottom:14px}
    .card{background:#0e1733; border:1px solid #223158; border-radius:var(--radius); padding:12px; margin-bottom:12px; box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    label{font-size:12px; opacity:.85; display:block; margin:4px 0}
    select, input[type="text"], textarea{width:100%; background:#0a132d; color:var(--text); border:1px solid #2b3a6a; border-radius:12px; padding:10px 12px; outline:none}
    textarea{min-height:68px; resize:vertical}

    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 12px; border-radius:12px; border:1px solid transparent; cursor:pointer; font-weight:600}
    .btn-primary{background:var(--accent); color:#082327}
    .btn-alt{background:#0a132d; color:var(--text); border-color:#2b3a6a}
    .btn-danger{background:#2a0e12; color:#ffcdd2; border-color:#6b1d26}
    .btn:active{transform:translateY(1px)}

    .chips{display:flex; flex-wrap:wrap; gap:6px; margin-top:6px}
    .chip{display:inline-flex; align-items:center; gap:6px; background:#0a132d; border:1px solid #2b3a6a; padding:6px 10px; border-radius:999px; font-size:12px}
    .chip .dot{width:10px; height:10px; border-radius:50%}

    /* Map */
    #map{height:100vh; width:100%;}
    .leaflet-control-geocoder{max-width:260px}

    /* Marker icon (divIcon) */
    .pin{position:relative; width:24px; height:24px; border-radius:50%; box-shadow:0 0 0 3px rgba(0,0,0,.25); display:grid; place-items:center; font-weight:700; color:white}
    .pin::after{content:""; position:absolute; bottom:-6px; left:50%; transform:translateX(-50%); width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-top:8px solid currentColor; filter:brightness(.8)}
    .pin.bad{background:var(--bad)}
    .pin.warn{background:var(--warn); color:#201a00}
    .pin.ok{background:var(--ok)}
    .pin.blue{background:#3b82f6}
    .pin.purple{background:#a855f7}
    .pin.gray{background:#64748b}

    .legend{display:flex; gap:8px; align-items:center; padding:6px 10px; background:#0a132d; border:1px solid #2b3a6a; border-radius:12px; box-shadow:0 6px 14px rgba(0,0,0,.25)}
    .legend .sw{width:12px; height:12px; border-radius:3px}

    .footer{position:absolute; bottom:10px; left:16px; right:16px; display:flex; gap:8px; flex-wrap:wrap}
    .small{font-size:12px; opacity:.75}

    @media (max-width: 980px){ .app{grid-template-columns:1fr} aside{order:2} #map{order:1; height:60vh} }
  </style>
</head>
<body>
<div class="app">
  <aside>
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px">
      <h1>üó∫Ô∏è Mapa de problemas</h1>
      <button id="themeToggle" class="btn btn-alt" title="Cambiar tema">üåô Oscuro</button>
    </div>
    <div class="subtitle">Agrega <b>waypoints</b>, dibuja √°reas y clasifica cada reporte. Exporta/Importa en GeoJSON.</div>

    <div class="card">
      <div class="row">
        <div>
          <label>Categor√≠a</label>
          <select id="categoria">
            <option>Basura</option>
            <option>Iluminaci√≥n</option>
            <option>Seguridad</option>
            <option>V√≠as</option>
            <option>Ruido</option>
            <option>Otros</option>
          </select>
        </div>
        <div>
          <label>Severidad</label>
          <select id="severidad">
            <option value="alta">Alta</option>
            <option value="media" selected>Media</option>
            <option value="baja">Baja</option>
          </select>
        </div>
      </div>
      <label>Descripci√≥n</label>
      <textarea id="descripcion" placeholder="¬øQu√© pasa aqu√≠?"></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn btn-alt" id="toggleAdd">‚ûï Modo a√±adir (clic en el mapa)</button>
        <button class="btn btn-primary" id="addHere">üìç A√±adir aqu√≠ (centro)</button>
      </div>
    </div>

    <div class="card">
      <b>Filtros</b>
      <div class="chips" id="chipsCategorias"></div>
      <div class="chips" id="chipsEstado" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <b>Datos</b>
      <div class="row" style="margin-top:6px">
        <button class="btn btn-alt" id="btnExport">‚¨áÔ∏è Exportar GeoJSON</button>
        <label class="btn btn-alt" for="fileImport" style="cursor:pointer">‚¨ÜÔ∏è Importar GeoJSON</label>
        <input id="fileImport" type="file" accept="application/json,.geojson" style="display:none" />
      </div>
    </div>

    <div class="small">Consejos: usa la lupa para buscar sitios, el bot√≥n de ubicaci√≥n para centrarte y las herramientas de dibujo para delimitar √°reas problem√°ticas. Haz clic en un pin para editarlo, cambiar estado o borrarlo.</div>

    <div class="footer">
      <div class="legend">
        <span class="sw" style="background:#3b82f6"></span> Basura
        <span class="sw" style="background:#ffd166"></span> Iluminaci√≥n
        <span class="sw" style="background:#ef5350"></span> Seguridad
        <span class="sw" style="background:#4caf50"></span> V√≠as
        <span class="sw" style="background:#a855f7"></span> Ruido
        <span class="sw" style="background:#64748b"></span> Otros
      </div>
    </div>
  </aside>

  <div id="map"></div>
</div>

<script>
  // ======= Basemaps =======
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20,
    attribution: '&copy; <a target="_blank" href="https://www.openstreetmap.org/copyright">OSM</a>'
  });
  const cartoDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 20,
    attribution: '&copy; <a target="_blank" href="https://carto.com/attributions">CARTO</a> & OSM'
  });

  // ======= Mapa =======
  const map = L.map('map', {
    center: [4.7110, -74.0721], // Bogot√° como centro
    zoom: 12,
    layers: [cartoDark]
  });
  const baseLayers = { 'CARTO Dark': cartoDark, 'OSM': osm };
  L.control.layers(baseLayers).addTo(map);

  // Tema inicial
document.body.setAttribute('data-theme','dark');
let currentTheme = 'dark';

// Geocoder y localizar
  const geocoder = L.Control.geocoder({ defaultMarkGeocode:false }).on('markgeocode', e => {
    map.fitBounds(e.geocode.bbox);
  }).addTo(map);

  const locateBtn = L.control({position:'topleft'});
  locateBtn.onAdd = () => {
    const btn = L.DomUtil.create('button','btn btn-primary');
    btn.innerHTML = 'üìç Mi ubicaci√≥n';
    btn.style.margin = '8px';
    L.DomEvent.on(btn,'click', (ev)=>{ L.DomEvent.stop(ev); map.locate({setView:true, maxZoom:16}); });
    return btn;
  }
  locateBtn.addTo(map);

  // Toggle de tema claro/oscuro
  document.getElementById('themeToggle').addEventListener('click', ()=>{
    if(currentTheme==='dark'){
      currentTheme='light';
      document.body.setAttribute('data-theme','light');
      if(map.hasLayer(cartoDark)) map.removeLayer(cartoDark);
      if(!map.hasLayer(osm)) map.addLayer(osm);
      document.getElementById('themeToggle').textContent='‚òÄÔ∏è Claro';
    }else{
      currentTheme='dark';
      document.body.setAttribute('data-theme','dark');
      if(map.hasLayer(osm)) map.removeLayer(osm);
      if(!map.hasLayer(cartoDark)) map.addLayer(cartoDark);
      document.getElementById('themeToggle').textContent='üåô Oscuro';
    }
  });

  // ======= Dibujo de √°reas =======
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);
  const drawControl = new L.Control.Draw({
    position:'topleft',
    draw: {
      polyline: { shapeOptions:{ color:'#5bc0be', weight:3 } },
      polygon: { allowIntersection:false, showArea:true, shapeOptions:{ color:'#ffd166' } },
      rectangle: { shapeOptions:{ color:'#a855f7' } },
      circle: { shapeOptions:{ color:'#ef5350' } },
      circlemarker: false,
      marker: false
    },
    edit: { featureGroup: drawnItems }
  });
  map.addControl(drawControl);
  map.on(L.Draw.Event.CREATED, (e)=>{ drawnItems.addLayer(e.layer); });

  // ======= Clustering de marcadores =======
  const cluster = L.markerClusterGroup({ 
    disableClusteringAtZoom: 18,
    showCoverageOnHover: false,
    spiderfyOnEveryZoom: true,
    spiderfyOnMaxZoom: true,
    zoomToBoundsOnClick: true
  });
  map.addLayer(cluster);

  // ======= Estado global =======
  const form = {
    get categoria(){ return document.getElementById('categoria').value; },
    get severidad(){ return document.getElementById('severidad').value; },
    get descripcion(){ return document.getElementById('descripcion').value.trim(); }
  }
  let addMode = false;
  const markers = []; // [{ marker, props }]

  // ======= Iconos seg√∫n categor√≠a / severidad =======
  const catColor = (cat)=>({
    'Basura':'#3b82f6',
    'Iluminaci√≥n':'#ffd166',
    'Seguridad':'#ef5350',
    'V√≠as':'#4caf50',
    'Ruido':'#a855f7',
    'Otros':'#64748b',
    // Categor√≠as del proyecto
    'Vendedores ambulantes':'#3b82f6',      // azul
    'Ciclo ruta':'#ffd166',                  // amarillo
    'Contaminaci√≥n visual':'#a855f7',       // morado
    'Casas en mal estado':'#ef5350',        // rojo
    'Edificios en mal estado':'#ef5350',    // rojo
    'Casas abandonadas':'#ef5350',          // rojo
    'Se√±alizaci√≥n':'#22c55e',               // verde lima
    'Calles en mal estado':'#4caf50'        // verde
  }[cat] || '#64748b');

  const sevClass = (sev)=>({ alta:'bad', media:'warn', baja:'ok' }[sev] || 'ok');

  function makeIcon(cat, sev){
    const color = catColor(cat);
    const sevC = sevClass(sev);
    const html = `<div class="pin ${sevC}" style="background:${color}; color:${color}"><span style="filter:invert(1); color:white;">‚Ä¢</span></div>`;
    return L.divIcon({ className:'', html, iconSize:[24,30], iconAnchor:[12,28], popupAnchor:[0,-20] });
  }

  // ======= Crear marcador =======
  function addMarker(latlng, {categoria, severidad, descripcion}){
    const props = {
      categoria, severidad, descripcion,
      estado: 'pendiente',
      createdAt: new Date().toISOString()
    };
    const m = L.marker(latlng, { icon: makeIcon(props.categoria, props.severidad) });
    m.bindPopup(makePopupHTML(props), { maxWidth: 280 });
    m.on('popupopen', ()=> attachPopupHandlers(m, props));
    cluster.addLayer(m);
    const entry = { marker: m, props };
    markers.push(entry);
    // asegurar visibilidad inmediata (evita que "desaparezca" dentro de un cl√∫ster)
    cluster.zoomToShowLayer(m, ()=>{ m.openPopup(); });
    return entry;
  }

  function makePopupHTML(p){
    return `
      <div style="font: 14px system-ui">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:6px">
          <b>${p.categoria}</b>
          <span class="chip"><span class="dot" style="background:${catColor(p.categoria)}"></span>${p.severidad}</span>
        </div>
        <div style="opacity:.9; white-space:pre-wrap;">${(p.descripcion||'‚Äî')}</div>
        <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap">
          <button class="btn btn-primary" data-act="edit">‚úèÔ∏è Editar</button>
          <button class="btn btn-alt" data-act="estado">üîÑ Estado: ${p.estado}</button>
          <button class="btn btn-danger" data-act="del">üóëÔ∏è Borrar</button>
        </div>
      </div>`;
  }

  function attachPopupHandlers(marker, props){
    const container = marker.getPopup().getElement();
    if(!container) return;
    container.querySelector('[data-act="edit"]').onclick = ()=>{
      const c = prompt('Categor√≠a (Basura, Iluminaci√≥n, Seguridad, V√≠as, Ruido, Otros):', props.categoria) || props.categoria;
      const s = prompt('Severidad (alta, media, baja):', props.severidad) || props.severidad;
      const d = prompt('Descripci√≥n:', props.descripcion) ?? props.descripcion;
      props.categoria = c; props.severidad = s; props.descripcion = d;
      marker.setIcon(makeIcon(c, s));
      marker.setPopupContent(makePopupHTML(props));
      marker.openPopup();
      applyFilters();
    };
    container.querySelector('[data-act="estado"]').onclick = ()=>{
      props.estado = (props.estado === 'pendiente') ? 'en progreso' : (props.estado === 'en progreso' ? 'resuelto' : 'pendiente');
      marker.setPopupContent(makePopupHTML(props));
      marker.openPopup();
      applyFilters();
    };
    container.querySelector('[data-act="del"]').onclick = ()=>{
      cluster.removeLayer(marker);
      const idx = markers.findIndex(x=>x.marker===marker);
      if(idx>-1) markers.splice(idx,1);
    };
  }

  // ======= UI: chips de filtro =======
  const CATEGORIAS = ['Basura','Iluminaci√≥n','Seguridad','V√≠as','Ruido','Otros'];
  const ESTADOS = ['pendiente','en progreso','resuelto'];
  const chipsCategorias = document.getElementById('chipsCategorias');
  const chipsEstado = document.getElementById('chipsEstado');
  const activeFilters = { categorias: new Set(CATEGORIAS), estados: new Set(ESTADOS) };

  function renderChips(){
    chipsCategorias.innerHTML = CATEGORIAS.map(c=>`
      <label class="chip" style="cursor:pointer">
        <input type="checkbox" data-cat="${c}" ${activeFilters.categorias.has(c)?'checked':''} />
        <span class="dot" style="background:${catColor(c)}"></span>${c}
      </label>`).join('');

    chipsEstado.innerHTML = ESTADOS.map(e=>`
      <label class="chip" style="cursor:pointer">
        <input type="checkbox" data-est="${e}" ${activeFilters.estados.has(e)?'checked':''} />
        ${e}
      </label>`).join('');

    chipsCategorias.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        if(cb.checked) activeFilters.categorias.add(cb.dataset.cat); else activeFilters.categorias.delete(cb.dataset.cat);
        applyFilters();
      });
    });
    chipsEstado.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        if(cb.checked) activeFilters.estados.add(cb.dataset.est); else activeFilters.estados.delete(cb.dataset.est);
        applyFilters();
      });
    });
  }
  renderChips();

  function applyFilters(){
    // reconstruir cluster para que respete ocultamientos
    cluster.clearLayers();
    markers.forEach(({marker, props})=>{
      const ok = activeFilters.categorias.has(props.categoria) && activeFilters.estados.has(props.estado);
      if(ok) cluster.addLayer(marker);
    });
  }

  // ======= Eventos UI =======
  document.getElementById('toggleAdd').onclick = (e)=>{
    addMode = !addMode;
    e.target.textContent = addMode ? '‚úÖ A√±adir: ACTIVADO (clic en el mapa)' : '‚ûï Modo a√±adir (clic en el mapa)';
    e.target.className = addMode ? 'btn btn-primary' : 'btn btn-alt';
  };

  document.getElementById('addHere').onclick = ()=>{
    const center = map.getCenter();
    const { marker } = addMarker([center.lat, center.lng], { categoria: form.categoria, severidad: form.severidad, descripcion: form.descripcion });
    cluster.zoomToShowLayer(marker, ()=>{ marker.openPopup(); });
  };

  map.on('click', (ev)=>{
    if(!addMode) return;
    addMarker(ev.latlng, { categoria: form.categoria, severidad: form.severidad, descripcion: form.descripcion });
  });

  // ======= Export / Import =======
  document.getElementById('btnExport').onclick = ()=>{
    const features = [];
    // markers
    markers.forEach(({marker, props})=>{
      const ll = marker.getLatLng();
      features.push({
        type:'Feature',
        geometry:{ type:'Point', coordinates:[ll.lng, ll.lat] },
        properties:{ ...props, _type:'marker' }
      });
    });
    // drawn shapes
    const drawn = drawnItems.toGeoJSON();
    drawn.features.forEach(f=>{ f.properties = { ...(f.properties||{}), _type:'shape' }; });

    const geojson = { type:'FeatureCollection', features:[...features, ...drawn.features] };
    const blob = new Blob([JSON.stringify(geojson, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'mapa-problemas.geojson';
    a.click();
  };

  document.getElementById('fileImport').addEventListener('change', (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        // limpiar actuales
        cluster.clearLayers();
        markers.splice(0, markers.length);
        drawnItems.clearLayers();

        (data.features||[]).forEach(f=>{
          const t = (f.properties && f.properties._type) || (f.geometry && f.geometry.type === 'Point' ? 'marker' : 'shape');
          if(t==='marker' && f.geometry && f.geometry.type==='Point'){
            const [lng, lat] = f.geometry.coordinates;
            addMarker([lat, lng], {
              categoria: f.properties?.categoria || 'Otros',
              severidad: f.properties?.severidad || 'media',
              descripcion: f.properties?.descripcion || ''
            }).props.estado = f.properties?.estado || 'pendiente';
          } else if (t==='shape') {
            const lyr = L.geoJSON(f, { style:{ color:'#5bc0be' } });
            lyr.eachLayer(l=> drawnItems.addLayer(l));
          }
        });
        applyFilters();
        alert('GeoJSON importado ‚úÖ');
      }catch(err){
        console.error(err); alert('Archivo inv√°lido');
      }
    };
    reader.readAsText(file);
  });

  // Carga inicial de puntos (colores por categor√≠a)
  const seed = [
    { lat:4.64999, lng:-74.06294, nombre:'Entrevistas', categoria:'Otros', descripcion:'Se hacen entrevistas a personas que concurren por la zona y habitan en el sector.' },
    { lat:4.64928, lng:-74.06354, nombre:'Vendedores ambulantes', categoria:'Vendedores ambulantes', descripcion:'Invasi√≥n de zona peatonal; dificultad para transitar con normalidad.' },
    { lat:4.64837, lng:-74.06362, nombre:'Ciclo ruta', categoria:'Ciclo ruta', descripcion:'Invasi√≥n de la ciclorruta por peatones y espacio reducido.' },
    { lat:4.64796, lng:-74.06375, nombre:'Ciclo ruta', categoria:'Ciclo ruta', descripcion:'Espacios reducidos debido a la ciclorruta.' },
    { lat:4.65031, lng:-74.06347, nombre:'Contaminaci√≥n visual', categoria:'Contaminaci√≥n visual', descripcion:'Letreros en mal estado y exceso de publicidad.' },
    { lat:4.64033, lng:-74.06260, nombre:'Casas en mal estado', categoria:'Casas en mal estado', descripcion:'Edificio en mal estado que genera inseguridad.' },
    { lat:4.64403, lng:-74.06579, nombre:'Edificios en mal estado', categoria:'Edificios en mal estado', descripcion:'Estructuras con deterioro visible.' },
    { lat:4.64275, lng:-74.06217, nombre:'Casas abandonadas', categoria:'Casas abandonadas', descripcion:'Con grafitis y en mal estado.' },
    { lat:4.64036, lng:-74.06503, nombre:'Ciclo ruta', categoria:'Ciclo ruta', descripcion:'Conflictos de uso y paso.' },
    { lat:4.64065, lng:-74.06622, nombre:'Se√±alizaci√≥n', categoria:'Se√±alizaci√≥n', descripcion:'Falta o deficiencia de se√±alizaci√≥n.' },
    { lat:4.64257, lng:-74.06614, nombre:'Calles en mal estado', categoria:'Calles en mal estado', descripcion:'Calzada deteriorada.' },
    { lat:4.64616, lng:-74.06547, nombre:'Edificios en mal estado', categoria:'Edificios en mal estado', descripcion:'Fisuras y desgaste de fachada.' },
    { lat:4.64585, lng:-74.06406, nombre:'Vendedores ambulantes', categoria:'Vendedores ambulantes', descripcion:'Ocupaci√≥n de and√©n.' }
  ];
  seed.forEach(p=> addMarker([p.lat, p.lng], { nombre:p.nombre, categoria:p.categoria, severidad:'media', descripcion:p.descripcion }));
