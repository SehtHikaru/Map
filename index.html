<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa interactivo ‚Äî Problemas Urbanos</title>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <!-- Leaflet.Draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <!-- Geocoder -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    :root{
      --bg:#0b132b; --panel:#1c2541; --muted:#3a506b; --accent:#5bc0be; --accent2:#ffd166; --text:#eaf2f8;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --radius:18px;
    }
    body[data-theme="light"]{
      --bg:#ffffff; --panel:#f4f6fb; --muted:#cbd5e1; --accent:#2563eb; --accent2:#f59e0b; --text:#1f2937;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text);}
    .app{display:grid; grid-template-columns:380px 1fr; min-height:100vh}
    aside{background:linear-gradient(180deg, var(--panel), #121a35); padding:16px 16px 24px; border-right:1px solid #243057; position:relative}
    h1{font-size:20px; margin:0; letter-spacing:.2px}
    .subtitle{opacity:.85; font-size:12px; margin:8px 0 12px}
    .card{background:#0e1733; border:1px solid #223158; border-radius:var(--radius); padding:12px; margin-bottom:12px; box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    label{font-size:12px; opacity:.9; display:block; margin:4px 0}
    select, input[type="text"], textarea{width:100%; background:#0a132d; color:var(--text); border:1px solid #2b3a6a; border-radius:12px; padding:10px 12px; outline:none}
    textarea{min-height:64px; resize:vertical}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 12px; border-radius:12px; border:1px solid transparent; cursor:pointer; font-weight:600}
    .btn-primary{background:var(--accent); color:#082327}
    .btn-alt{background:#0a132d; color:var(--text); border-color:#2b3a6a}
    .btn-danger{background:#2a0e12; color:#ffcdd2; border-color:#6b1d26}
    .btn:active{transform:translateY(1px)}
    .small{font-size:12px; opacity:.8}
    #map{height:100vh; width:100%}
    .legend{display:flex; gap:8px; align-items:center; padding:6px 10px; background:#0a132d; border:1px solid #2b3a6a; border-radius:12px; box-shadow:0 6px 14px rgba(0,0,0,.25)}
    .legend .sw{width:12px; height:12px; border-radius:3px}
    .pin{position:relative; width:24px; height:24px; border-radius:50%; box-shadow:0 0 0 3px rgba(0,0,0,.25); display:grid; place-items:center; color:white}
    .pin::after{content:""; position:absolute; bottom:-6px; left:50%; transform:translateX(-50%); width:0; height:0; border-left:6px solid transparent; border-right:6px solid transparent; border-top:8px solid currentColor; filter:brightness(.8)}
    @media (max-width: 980px){ .app{grid-template-columns:1fr} aside{order:2} #map{order:1; height:60vh} }
  </style>
</head>
<body>
<div class="app">
  <aside>
    <div style="display:flex; align-items:center; justify-content:space-between; gap:8px">
      <h1>üó∫Ô∏è Mapa de problemas</h1>
      <button id="themeToggle" class="btn btn-alt" title="Cambiar tema">üåô Oscuro</button>
    </div>
    <div class="subtitle">Waypoints con <b>nombre</b> y <b>descripci√≥n</b>. Edici√≥n desde el panel lateral. Exporta/Importa GeoJSON.</div>

    <div class="card">
      <div class="row">
        <div>
          <label>Nombre</label>
          <input id="nombre" type="text" placeholder="Ej. Vendedores ambulantes" />
        </div>
        <div>
          <label>Categor√≠a</label>
          <select id="categoria">
            <option>Vendedores ambulantes</option>
            <option>Ciclo ruta</option>
            <option>Contaminaci√≥n visual</option>
            <option>Casas en mal estado</option>
            <option>Edificios en mal estado</option>
            <option>Casas abandonadas</option>
            <option>Se√±alizaci√≥n</option>
            <option>Calles en mal estado</option>
            <option>Otros</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div>
          <label>Severidad</label>
          <select id="severidad">
            <option value="alta">Alta</option>
            <option value="media" selected>Media</option>
            <option value="baja">Baja</option>
          </select>
        </div>
      </div>
      <label style="margin-top:6px">Descripci√≥n</label>
      <textarea id="descripcion" placeholder="A√±ade una nota breve del problema"></textarea>

      <div class="row" style="margin-top:10px">
        <button class="btn btn-alt" id="toggleAdd">‚ûï Modo a√±adir (clic en el mapa)</button>
        <button class="btn btn-primary" id="addHere">üìç A√±adir aqu√≠ (centro)</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn btn-primary" id="btnUpdate">‚úèÔ∏è Actualizar seleccionado</button>
        <button class="btn btn-danger" id="btnDelete">üóëÔ∏è Borrar seleccionado</button>
      </div>
      <div id="selInfo" class="small" style="margin-top:6px; opacity:.9">Ning√∫n punto seleccionado</div>
    </div>

    <div class="card">
      <b>Filtros</b>
      <div class="small">Activa/desactiva para mostrar por tipo y estado.</div>
      <div id="chipsCategorias" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:8px"></div>
      <div id="chipsEstado" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:8px"></div>
    </div>

    <div class="card">
      <b>Datos</b>
      <div class="row" style="margin-top:6px">
        <button class="btn btn-alt" id="btnExport">‚¨áÔ∏è Exportar GeoJSON</button>
        <label class="btn btn-alt" for="fileImport" style="cursor:pointer">‚¨ÜÔ∏è Importar GeoJSON</label>
        <input id="fileImport" type="file" accept="application/json,.geojson" style="display:none" />
      </div>
    </div>

    <div class="small">Consejo: usa la lupa para buscar sitios, el bot√≥n de ubicaci√≥n para centrarte y las herramientas de dibujo (pol√≠gonos/rect√°ngulos) para delimitar √°reas.</div>

    <div style="position:absolute; bottom:10px; left:16px; right:16px; display:flex; gap:8px; flex-wrap:wrap">
      <div class="legend">
        <span class="sw" style="background:#3b82f6"></span> Vendedores
        <span class="sw" style="background:#ffd166"></span> Ciclo ruta
        <span class="sw" style="background:#a855f7"></span> Contam. visual
        <span class="sw" style="background:#ef5350"></span> Casas/Edif. mal estado
        <span class="sw" style="background:#22c55e"></span> Se√±alizaci√≥n
        <span class="sw" style="background:#4caf50"></span> Calles
      </div>
    </div>
  </aside>

  <div id="map"></div>
</div>

<script>
  // ======= Capas base (oscuro y claro) =======
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20, attribution: '&copy; <a target="_blank" href="https://www.openstreetmap.org/copyright">OSM</a>'
  });
  const cartoDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    maxZoom: 20, attribution: '&copy; <a target="_blank" href="https://carto.com/attributions">CARTO</a> & OSM'
  });

  // ======= Inicializar mapa (tema oscuro por defecto) =======
  document.body.setAttribute('data-theme','dark');
  let currentTheme = 'dark';

  const map = L.map('map', {
    center: [4.7110, -74.0721], // Bogot√° (se reajustar√° a los puntos)
    zoom: 12,
    layers: [cartoDark]
  });
  L.control.layers({ 'CARTO Dark': cartoDark, 'OSM': osm }).addTo(map);

  // Geocoder y localizar
  const geocoder = L.Control.geocoder({ defaultMarkGeocode:false }).on('markgeocode', e => {
    map.fitBounds(e.geocode.bbox);
  }).addTo(map);

  const locateBtn = L.control({position:'topleft'});
  locateBtn.onAdd = () => {
    const btn = L.DomUtil.create('button','btn btn-primary');
    btn.innerHTML = 'üìç Mi ubicaci√≥n';
    btn.style.margin = '8px';
    L.DomEvent.on(btn,'click', (ev)=>{ L.DomEvent.stop(ev); map.locate({setView:true, maxZoom:16}); });
    return btn;
  }
  locateBtn.addTo(map);

  // ======= Controles de dibujo de √°reas =======
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);
  const drawControl = new L.Control.Draw({
    position:'topleft',
    draw: {
      polyline: { shapeOptions:{ color:'#5bc0be', weight:3 } },
      polygon: { allowIntersection:false, showArea:true, shapeOptions:{ color:'#ffd166' } },
      rectangle: { shapeOptions:{ color:'#a855f7' } },
      circle: { shapeOptions:{ color:'#ef5350' } },
      circlemarker: false,
      marker: false
    },
    edit: { featureGroup: drawnItems }
  });
  map.addControl(drawControl);
  map.on(L.Draw.Event.CREATED, (e)=>{ drawnItems.addLayer(e.layer); });

  // ======= Cluster =======
  const cluster = L.markerClusterGroup({
    disableClusteringAtZoom: 18,
    showCoverageOnHover: false,
    spiderfyOnEveryZoom: true,
    spiderfyOnMaxZoom: true,
    zoomToBoundsOnClick: true
  });
  map.addLayer(cluster);

  // ======= Estado global =======
  const form = {
    get nombre(){ return document.getElementById('nombre').value.trim(); },
    get categoria(){ return document.getElementById('categoria').value; },
    get severidad(){ return document.getElementById('severidad').value; },
    get descripcion(){ return document.getElementById('descripcion').value.trim(); }
  };
  let addMode = false;
  let selected = null; // { marker, props }
  const markers = [];  // [{ marker, props }]

  // ======= Colores por categor√≠a =======
  const catColor = (cat)=>({
    'Vendedores ambulantes':'#3b82f6',      // azul
    'Ciclo ruta':'#ffd166',                  // amarillo
    'Contaminaci√≥n visual':'#a855f7',       // morado
    'Casas en mal estado':'#ef5350',        // rojo
    'Edificios en mal estado':'#ef5350',    // rojo
    'Casas abandonadas':'#ef5350',          // rojo
    'Se√±alizaci√≥n':'#22c55e',               // verde lima
    'Calles en mal estado':'#4caf50',       // verde
    'Otros':'#64748b'
  }[cat] || '#64748b');

  const sevClass = (sev)=>({ alta:'bad', media:'warn', baja:'ok' }[sev] || 'ok');

  function makeIcon(cat, sev){
    const color = catColor(cat);
    const html = `<div class="pin" style="background:${color}; color:${color}"><span style="filter:invert(1); color:white;">‚Ä¢</span></div>`;
    return L.divIcon({ className:'', html, iconSize:[24,30], iconAnchor:[12,28], popupAnchor:[0,-20] });
  }

  function makePopupHTML(p){
    // Popups limpios: solo nombre + descripci√≥n
    return `
      <div style="font:14px system-ui">
        <b style="display:block; margin-bottom:4px">${p.nombre || 'Sin t√≠tulo'}</b>
        <div style="opacity:.9; white-space:pre-wrap;">${(p.descripcion || '‚Äî')}</div>
      </div>`;
  }

  function selectMarker(entry){
    selected = entry;
    const { props } = entry;
    // Mostrar selecci√≥n en panel
    document.getElementById('selInfo').textContent = `Seleccionado: ${props.nombre} ‚Äî ${props.categoria}`;
    // Rellenar formulario para editar r√°pido (no abre popup)
    document.getElementById('nombre').value = props.nombre || '';
    document.getElementById('categoria').value = props.categoria || 'Otros';
    document.getElementById('severidad').value = props.severidad || 'media';
    document.getElementById('descripcion').value = props.descripcion || '';
  }

  function addMarker(latlng, {nombre, categoria, severidad, descripcion}){
    const props = {
      nombre: nombre || 'Sin t√≠tulo',
      categoria, severidad, descripcion,
      estado: 'pendiente',
      createdAt: new Date().toISOString()
    };
    const m = L.marker(latlng, { icon: makeIcon(props.categoria, props.severidad) });
    m.bindPopup(makePopupHTML(props), { maxWidth: 280 });
    cluster.addLayer(m);
    const entry = { marker: m, props };
    markers.push(entry);
    m.on('click', ()=> selectMarker(entry));
    return entry;
  }

  // ======= Filtros =======
  const CATEGORIAS = [
    'Vendedores ambulantes','Ciclo ruta','Contaminaci√≥n visual',
    'Casas en mal estado','Edificios en mal estado','Casas abandonadas',
    'Se√±alizaci√≥n','Calles en mal estado','Otros'
  ];
  const ESTADOS = ['pendiente','en progreso','resuelto'];
  const activeFilters = { categorias: new Set(CATEGORIAS), estados: new Set(ESTADOS) };

  function renderChips(){
    const chipsCategorias = document.getElementById('chipsCategorias');
    const chipsEstado = document.getElementById('chipsEstado');
    chipsCategorias.innerHTML = CATEGORIAS.map(c=>`
      <label class="btn btn-alt" style="gap:6px">
        <input type="checkbox" data-cat="${c}" ${activeFilters.categorias.has(c)?'checked':''} /> ${c}
      </label>`).join('');
    chipsEstado.innerHTML = ESTADOS.map(e=>`
      <label class="btn btn-alt" style="gap:6px">
        <input type="checkbox" data-est="${e}" ${activeFilters.estados.has(e)?'checked':''} /> ${e}
      </label>`).join('');

    chipsCategorias.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        if(cb.checked) activeFilters.categorias.add(cb.dataset.cat); else activeFilters.categorias.delete(cb.dataset.cat);
        applyFilters();
      });
    });
    chipsEstado.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        if(cb.checked) activeFilters.estados.add(cb.dataset.est); else activeFilters.estados.delete(cb.dataset.est);
        applyFilters();
      });
    });
  }
  function applyFilters(){
    cluster.clearLayers();
    markers.forEach(({marker, props})=>{
      const ok = activeFilters.categorias.has(props.categoria) && activeFilters.estados.has(props.estado);
      if(ok) cluster.addLayer(marker);
    });
  }
  renderChips();

  // ======= Eventos UI =======
  document.getElementById('themeToggle').addEventListener('click', ()=>{
    if(currentTheme==='dark'){
      currentTheme='light';
      document.body.setAttribute('data-theme','light');
      if(map.hasLayer(cartoDark)) map.removeLayer(cartoDark);
      if(!map.hasLayer(osm)) map.addLayer(osm);
      document.getElementById('themeToggle').textContent='‚òÄÔ∏è Claro';
    }else{
      currentTheme='dark';
      document.body.setAttribute('data-theme','dark');
      if(map.hasLayer(osm)) map.removeLayer(osm);
      if(!map.hasLayer(cartoDark)) map.addLayer(cartoDark);
      document.getElementById('themeToggle').textContent='üåô Oscuro';
    }
  });

  document.getElementById('toggleAdd').onclick = (e)=>{
    addMode = !addMode;
    e.target.textContent = addMode ? '‚úÖ A√±adir: ACTIVADO (clic en el mapa)' : '‚ûï Modo a√±adir (clic en el mapa)';
    e.target.className = addMode ? 'btn btn-primary' : 'btn btn-alt';
  };
  document.getElementById('addHere').onclick = ()=>{
    const c = map.getCenter();
    const entry = addMarker([c.lat, c.lng], { nombre: form.nombre, categoria: form.categoria, severidad: form.severidad, descripcion: form.descripcion });
    cluster.zoomToShowLayer(entry.marker, ()=>{ entry.marker.openPopup(); selectMarker(entry); });
  };
  document.getElementById('btnUpdate').onclick = ()=>{
    if(!selected){ alert('Selecciona un punto (clic en un pin)'); return; }
    const p = selected.props;
    p.nombre = form.nombre || p.nombre;
    p.categoria = form.categoria || p.categoria;
    p.severidad = form.severidad || p.severidad;
    p.descripcion = form.descripcion || p.descripcion;
    selected.marker.setIcon(makeIcon(p.categoria, p.severidad));
    selected.marker.setPopupContent(makePopupHTML(p));
    applyFilters();
  };
  document.getElementById('btnDelete').onclick = ()=>{
    if(!selected){ alert('No hay punto seleccionado'); return; }
    cluster.removeLayer(selected.marker);
    const idx = markers.findIndex(x=>x===selected);
    if(idx>-1) markers.splice(idx,1);
    selected = null;
    document.getElementById('selInfo').textContent = 'Ning√∫n punto seleccionado';
  };

  map.on('click', (ev)=>{
    if(!addMode) return;
    const entry = addMarker(ev.latlng, { nombre: form.nombre, categoria: form.categoria, severidad: form.severidad, descripcion: form.descripcion });
    cluster.zoomToShowLayer(entry.marker, ()=>{ entry.marker.openPopup(); selectMarker(entry); });
  });

  // Export / Import
  document.getElementById('btnExport').onclick = ()=>{
    const features = [];
    markers.forEach(({marker, props})=>{
      const ll = marker.getLatLng();
      features.push({
        type:'Feature',
        geometry:{ type:'Point', coordinates:[ll.lng, ll.lat] },
        properties:{ ...props, _type:'marker' }
      });
    });
    const drawn = drawnItems.toGeoJSON();
    drawn.features.forEach(f=>{ f.properties = { ...(f.properties||{}), _type:'shape' }; });

    const geojson = { type:'FeatureCollection', features:[...features, ...drawn.features] };
    const blob = new Blob([JSON.stringify(geojson, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'mapa-problemas.geojson';
    a.click();
  };
  document.getElementById('fileImport').addEventListener('change', (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        // limpiar actuales
        cluster.clearLayers(); markers.splice(0, markers.length); drawnItems.clearLayers();
        (data.features||[]).forEach(f=>{
          const t = (f.properties && f.properties._type) || (f.geometry && f.geometry.type === 'Point' ? 'marker' : 'shape');
          if(t==='marker' && f.geometry && f.geometry.type==='Point'){
            const [lng, lat] = f.geometry.coordinates;
            const entry = addMarker([lat, lng], {
              nombre: f.properties?.nombre || 'Sin t√≠tulo',
              categoria: f.properties?.categoria || 'Otros',
              severidad: f.properties?.severidad || 'media',
              descripcion: f.properties?.descripcion || ''
            });
            entry.props.estado = f.properties?.estado || 'pendiente';
          } else if (t==='shape') {
            const lyr = L.geoJSON(f, { style:{ color:'#5bc0be' } });
            lyr.eachLayer(l=> drawnItems.addLayer(l));
          }
        });
        applyFilters();
        alert('GeoJSON importado ‚úÖ');
      }catch(err){
        console.error(err); alert('Archivo inv√°lido');
      }
    };
    reader.readAsText(file);
  });

  // ======= Semilla: puntos integrados (colores por categor√≠a) =======
  const seed = [
    { lat:4.64999, lng:-74.06294, nombre:'Entrevistas', categoria:'Otros',
      descripcion:'Se hacen entrevistas a personas que concurren por la zona y habitan en el sector.' },
    { lat:4.64928, lng:-74.06354, nombre:'Vendedores ambulantes', categoria:'Vendedores ambulantes',
      descripcion:'Invasi√≥n de zona peatonal; dificultad para transitar con normalidad.' },
    { lat:4.64837, lng:-74.06362, nombre:'Ciclo ruta', categoria:'Ciclo ruta',
      descripcion:'Invasi√≥n de la ciclorruta por peatones y espacio reducido.' },
    { lat:4.64796, lng:-74.06375, nombre:'Ciclo ruta', categoria:'Ciclo ruta',
      descripcion:'Espacios reducidos debido a la ciclorruta.' },
    { lat:4.65031, lng:-74.06347, nombre:'Contaminaci√≥n visual', categoria:'Contaminaci√≥n visual',
      descripcion:'Letreros en mal estado y exceso de publicidad.' },
    { lat:4.64033, lng:-74.06260, nombre:'Casas en mal estado', categoria:'Casas en mal estado',
      descripcion:'Edificio en mal estado que genera inseguridad.' },
    { lat:4.64403, lng:-74.06579, nombre:'Edificios en mal estado', categoria:'Edificios en mal estado',
      descripcion:'Estructuras con deterioro visible.' },
    { lat:4.64275, lng:-74.06217, nombre:'Casas abandonadas', categoria:'Casas abandonadas',
      descripcion:'Con grafitis y en mal estado.' },
    { lat:4.64036, lng:-74.06503, nombre:'Ciclo ruta', categoria:'Ciclo ruta',
      descripcion:'Conflictos de uso y paso.' },
    { lat:4.64065, lng:-74.06622, nombre:'Se√±alizaci√≥n', categoria:'Se√±alizaci√≥n',
      descripcion:'Falta o deficiencia de se√±alizaci√≥n.' },
    { lat:4.64257, lng:-74.06614, nombre:'Calles en mal estado', categoria:'Calles en mal estado',
      descripcion:'Calzada deteriorada.' },
    { lat:4.64616, lng:-74.06547, nombre:'Edificios en mal estado', categoria:'Edificios en mal estado',
      descripcion:'Fisuras y desgaste de fachada.' },
    { lat:4.64585, lng:-74.06406, nombre:'Vendedores ambulantes', categoria:'Vendedores ambulantes',
      descripcion:'Ocupaci√≥n de and√©n.' }
  ];

  const bounds = [];
  seed.forEach(p=>{
    const e = addMarker([p.lat, p.lng], { nombre:p.nombre, categoria:p.categoria, severidad:'media', descripcion:p.descripcion });
    bounds.push([p.lat, p.lng]);
  });
  // Ajuste autom√°tico al conjunto de puntos (Opci√≥n A)
  if(bounds.length){ map.fitBounds(bounds, { padding:[30,30] }); }
</script>
</body>
</html>
